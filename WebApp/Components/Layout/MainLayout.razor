@inherits RootLayout

<MudThemeProvider Theme="_currentTheme" />
<MudDialogProvider />
<MudSnackbarProvider />

<AuthorizeView>
    <NotAuthorized>
        <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="height: 100vh;">
            <MudPaper Elevation="25" Class="pa-8" Style="width: 500px;">
                @Body
            </MudPaper>
        </MudContainer>
    </NotAuthorized>

    <Authorized>
        <CascadingValue Value="this">

            <MudLayout>
                <MudAppBar Elevation="2">
                    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
                    <MudSpacer />
                    <TopRightBarSection />
                </MudAppBar>
                <MudDrawer @bind-Open="@_navMenuOpened" Elevation="2">
                    <UserProfile />
                    <NavMenu />
                    <DrawerFooter />
                </MudDrawer>
                <MudMainContent Style="min-height: 100vh; display: flex; flex-direction: column">
                    <MudContainer MaxWidth="MaxWidth.False" Style="flex: 1">
                        @TopSection
                        <MudPaper Class="py-4" Elevation="0">
                            @Body
                        </MudPaper>
                    </MudContainer>
                    <Footer />
                </MudMainContent>
                <MudScrollToTop TopOffset="400" Style="z-index:2000;">
                    <MudFab StartIcon="@Icons.Material.Filled.KeyboardArrowUp" Color="Color.Primary" />
                </MudScrollToTop>
            </MudLayout>
        </CascadingValue>
    </Authorized>
</AuthorizeView>

@code {

    private MudTheme _currentTheme;


    bool _navMenuOpened = true;

    [CascadingParameter]
    Task<AuthenticationState> authenticationStateTask { get; set; }

    [Inject] protected IAccountApiClient accountApiClient { get; set; }

    //Gets context that contains auth state
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    //Injects Nav Man to redirect
    [Inject] private NavigationManager? NavMan { get; set; }


    protected override async Task OnInitializedAsync()
    {

        _currentTheme = BlazorHeroTheme.DefaultTheme;

        var user = (await authenticationStateTask).User;

        if (user.Identity.IsAuthenticated)
        {
            var profile = await accountApiClient.GetUserProfile();

            _navMenuOpened = profile.IsNavOpen;
        }

        await Task.CompletedTask;

    }

    private void DrawerToggle()
    {
        _navMenuOpened = !_navMenuOpened;
    }
}
