@using WebApp.State
@inherits LayoutComponentBase
@attribute [Authorize(Policies.IsAdmin)]

<MudThemeProvider Theme="_currentTheme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<AuthorizeView>

    <Authorized>
        <MudLayout>
            <CascadingValue Value="this">
                <MudAppBar Elevation="25">
                    <MudIcon Icon="@CustomIcons.BlazorHero" Size="Size.Large" ViewBox="0 0 500 500" />
                    <MudText Typo="Typo.h6" Class="ml-4">MultiApp</MudText>
                    <MudToolBar DisableGutters="true">
                        <MudIconButton Icon="@Icons.Material.Outlined.Menu" Color="Color.Inherit" OnClick="@((e) => DrawerToggle())" Class="ml-3" />
                    </MudToolBar>
                    <MudSpacer />
                    <MudTooltip Text="Toggle Dark Mode">
                        <MudIconButton Icon="@Icons.Material.Filled.Brightness4" Color="Color.Inherit" OnClick="@((e) => ToggleDarkMode())" />
                    </MudTooltip>
                    <AccountProfile />
                </MudAppBar>
                <MudDrawer @bind-Open="_navMenuOpened" Elevation="25" ClipMode="DrawerClipMode.Always">
                    <AdminNavMenu />
                </MudDrawer>
                <MudMainContent Style="min-height: 100vh; display: flex; flex-direction: column">
                    <MudContainer MaxWidth="MaxWidth.False" Style="flex: 1">
                        @Body
                    </MudContainer>
                    <footer class="page-footer">
                        <TenantInfo />
                    </footer>
                </MudMainContent>
            </CascadingValue>
        </MudLayout>
    </Authorized>
</AuthorizeView>

@code {

    private MudTheme _currentTheme;

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    bool _navMenuOpened = true;

    bool _toggleDarkMode = true;

    [CascadingParameter]
    Task<AuthenticationState> authenticationStateTask { get; set; }

    [Inject] AppState appState { get; set; }

    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }
    private UserProfileViewModel? profile { get; set; }

    protected override async Task OnInitializedAsync()
    {

        _currentTheme = BlazorHeroTheme.DefaultTheme;

        var user = (await authenticationStateTask).User;

        // if (user.Identity!.IsAuthenticated)
        // {
        //     profile = await appState.GetUserProfile();

        _navMenuOpened = true;

        _toggleDarkMode = true;
        _currentTheme = _toggleDarkMode ? BlazorHeroTheme.DefaultTheme : BlazorHeroTheme.DarkTheme;
        // }

        await Task.CompletedTask;

    }

    public class CustomIcons
    {
        public static string BlazorHero { get; } = "<path d=\"M 37.00,90.00 C 37.00,90.00 328.90,90.00 328.90,90.00 328.90,90.00 328.90,410.00 328.90,410.00 328.90,410.00 37.00,410.00 37.00,410.00 37.00,410.00 37.00,90.00 37.00,90.00 Z M 381.49,90.75 C 381.49,90.75 464.00,90.75 464.00,90.75 464.00,90.75 464.00,410.00 464.00,410.00 464.00,410.00 381.49,410.00 381.49,410.00 381.49,410.00 381.49,280.80 381.49,280.80 381.49,280.80 337.37,280.80 337.37,280.80 337.37,280.80 337.37,220.44 337.37,220.44 337.37,220.44 381.49,220.44 381.49,220.44 381.49,220.44 381.49,90.75 381.49,90.75 Z M 119.51,150.36 C 119.51,150.36 119.51,220.44 119.51,220.44 119.51,220.44 236.91,220.44 236.91,220.44 236.91,220.44 236.91,280.80 236.91,280.80 236.91,280.80 119.51,280.80 119.51,280.80 119.51,280.80 119.51,349.64 119.51,349.64 119.51,349.64 246.39,349.64 246.39,349.64 246.39,349.64 246.39,150.36 246.39,150.36 246.39,150.36 119.51,150.36 119.51,150.36 Z\"/>";
    }

    private void DrawerToggle()
    {
        _navMenuOpened = !_navMenuOpened;
    }

    private async Task ToggleDarkMode()
    {
        _toggleDarkMode = !_toggleDarkMode;

        _currentTheme = _toggleDarkMode
            ? BlazorHeroTheme.DefaultTheme
            : BlazorHeroTheme.DarkTheme;

        await Task.FromResult(true);
    }

    private void Logout()
    {
        var parameters = new DialogParameters
            {
                {nameof(Dialogs.Logout.ContentText), $"Logout Confirmation"},
                {nameof(Dialogs.Logout.ButtonText), $"Logout"},
                {nameof(Dialogs.Logout.Color), Color.Error}
            };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        _dialogService.Show<Dialogs.Logout>("Logout", parameters, options);
    }
}
